# TOSA Conformance system

## TOSA validating tests

The `tosa_verify` executable (built with the reference model and located in
build/reference_model/verify) is used to validate the test results. It is called by the
tosa_verify_run_tests but can be called independently.

``` bash
tosa_verify
  --test_desc vtest/exp/exp_1_f16/desc.json \
  --bnd_result_file vtest/exp/exp_1_f16/bounds_result-0.runner.tosa_refmodel_compliance_sut_run.npy \
  --ref_result_file vtest/exp/exp_1_f16/result-0.runner.tosa_refmodel_compliance_sut_run.npy \
  --imp_result_file vtest/exp/exp_1_f16/result-0.runner.tosa_refmodel_sut_run.npy
```

Need the desc.json from the test path to read the compliance meta data, and the bounds file if
there is one. All data needs to be in numpy format.

### validation/compliance

To use the lib_tosa_reference_verify.so library a JSON meta data is needed to define how the data
will be verified. This is constructed in TosaTestGen.tensorComplianceMetaData() and will be stored
in desc.json - meta/compliance, for use in Lazy Data Generation mode or to recreate the data.

There are various modes for validation following the TOSA specification definition:
* DOT_PRODUCT
* ULP
* REDUCE_PRODUCT
* RELATIVE
* ABS_ERROR
* FP_SPECIAL
See tosa_verify for more info (reference_model/src/verify).

The operations of the lib_tosa_reference_verify.so library match the main compliance section
of the TOSA specification.

To encode these operations, a JSON config is supplied in the desc.json that includes the mode
and other information needed to perform the validation.

This table matches up the mode (from the validation/compliance section above), with an overview
of the requirements or special cases.

The bounds file is generated by the reference model when run in precise mode and abs_mode. It
* is the result but using absolute calculations, or
* provides additional input information to enable validation of the outputs.

| Validation Mode    | Bounds File | Bounds Output Content / Notes                                                            | Special Cases                       |
|--------------------|-------------|------------------------------------------------------------------------------------------|-------------------------------------|
| DOT_PRODUCT        | yes         | FP64 operation result using absolute value inputs                                        |                                     |
| ULP                | no          |                                                                                          |                                     |
| ABS_ERROR          | yes         | Partial specification of error bound calculation.                                        | lower_bound - to support TANH       |
|                    |             | For example in EXP: `err_bnd = abs(out_ref) * exp2(-normal_frac<in_out_t>) * (1+abs(x))` | normal_divisor - to support SIN/COS |
|                    |             | So the bounds file contains the values `(1+abs(x))` for each tensor index.               |                                     |
| EXACT              | no          |                                                                                          |                                     |
| REDUCE_PRODUCT     | no          |                                                                                          | Used for RESIZE                     |
| RELATIVE           | no          |                                                                                          |                                     |
| FP_SPECIAL         | yes         | Includes extra_multiples to accommodate NaNs in the final outputs padding areas          |                                     |

## Test details

### Naming of tests

``` bash
conformance_tests/operators/{group}/{operator}/{operator}_[kernel]_[ERRORIF_name]_{shape}_{type}_[attribute]..._[set number]_[special test]

Examples:
conformance_tests/operators/ew_binary/add/add_27_i32_is
conformance_tests/operators/ew_binary/add/add_ERRORIF_RankMismatch_4x7x2_f16
conformance_tests/operators/tensor/conv2d_1x1/\
  conv2d_1x1_1x16x51x7_bf16xbf16_accf32_st11_pad0000_dilat11_lclbnd1_s0
```

Meaning:

| Field         | Description                                                                                                                 |
|---------------|-----------------------------------------------------------------------------------------------------------------------------|
| group         | Name of the operator group — matches the division of operators in the specification (can be shortened version).             |
| operator      | Name of the operator.                                                                                                       |
| kernel        | (Optional) Kernel size under test for certain tensor operators.                                                             |
| ERRORIF_name  | (Optional) Error condition name for testing specific failures.                                                              |
| shape         | Shape of the main/first input tensor. Dimensions are separated by 'x'. Rank 0 is expressed as "0".                          |
| type          | Short form of the data type used in the main/first input tensor. Can be input type and weight type separated by 'x'.        |
| attribute     | (Optional) List of attributes/inputs and their settings for this operator test.                                             |
| set number    | (Optional) Indicates a set of tests numbered from zero (e.g., "s0").                                                        |
| special test  | (Optional) Flag indicating special test types:                                                                              |
|               | - "is": Integer special test (boundary conditions)                                                                          |
|               | - "fs": Floating-point special test (boundary conditions, NaN, infinities, ±zeroes)                                         |
|               | - "full": Exhaustive value testing (8-bit or 16-bit integer/floating point)                                                 |
|               | - "dyn": EXT-DYNAMIC dynamic input test, overrides Compile Time Constants (CTCs).                                           |

## Unit tests
There are two types of tests in reference_model:
* pytest - These reside in verif/tests and perform various simple tests on the Python tosa-tool
           scripts (tosa_verif_* tools in verif/) , and some tests on the C++ reference_model.
* C++ - These reside in reference_model/test and are built with the same command to build the
        reference_model to create a doctest executable unit_tests.

## License

The *TOSA Reference Model* and TOSA Unit Tests are licensed under Apache-2.0.

Copyright (c) 2025 Arm Limited.
